{% extends "base.html" %}
{% block content %}

<!-- ======================================================= -->
<!-- ================= HEADER COMPACTO ====================== -->
<!-- ======================================================= -->
<section class="mb-6 relative">

  <div class="rounded-xl p-5 
              bg-white/80 dark:bg-slate-900/80 
              backdrop-blur-xl 
              border border-slate-300 dark:border-slate-800 
              shadow-lg flex items-center justify-between relative">

    <div class="absolute -top-7 -left-7 w-24 h-24 
                bg-blue-500/10 dark:bg-blue-600/20 
                blur-2xl rounded-full"></div>

    <div class="relative flex items-center gap-4">
      <div class="p-3 bg-blue-500/10 dark:bg-blue-600/20 
                  rounded-lg border border-blue-300/30 dark:border-blue-500/20">
        <i class="fa-solid fa-clock-rotate-left text-blue-600 dark:text-blue-300 text-xl"></i>
      </div>

      <div>
        <h1 class="text-2xl font-bold text-slate-800 dark:text-white">
          Atividades Realizadas
        </h1>
        <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">
          Hist√≥rico completo das tarefas finalizadas
        </p>
      </div>
    </div>

    <!-- ‚úÖ contador -->
    <div class="relative text-right">
      <div class="text-[11px] text-slate-600 dark:text-slate-400">
        Mostrando <span class="font-semibold text-slate-800 dark:text-white">{{ logs|length }}</span>
        registro(s)
        {% if total_count %}
          de <span class="font-semibold text-slate-800 dark:text-white">{{ total_count }}</span>
        {% endif %}
      </div>
      {% if show %}
        <div class="text-[10px] text-slate-500 dark:text-slate-500 mt-1">
          Exibindo {{ show }} por vez (visualiza√ß√£o)
        </div>
      {% endif %}
    </div>

  </div>

</section>

<!-- ======================================================= -->
<!-- ======================= FILTROS ======================= -->
<!-- ======================================================= -->
<form method="GET"
      class="mb-6 bg-white/70 dark:bg-slate-900/60 
             backdrop-blur-xl p-4 rounded-xl shadow 
             border border-slate-300 dark:border-slate-800">

  <!-- ‚úÖ 5 colunas (Empresa, Colaborador, Per√≠odo, Ordenar, Bot√£o) -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">

    <!-- ================= EMPRESA ================= -->
    <div>
      <label class="text-xs font-semibold text-slate-600 dark:text-slate-300">
        Empresa
      </label>

      <select name="empresa"
              class="w-full mt-1 px-3 py-2 text-sm rounded-lg
                     bg-white dark:bg-slate-800
                     border border-slate-300 dark:border-slate-700">
        <option value="">Todas</option>

        {% for e in empresas %}
          <option value="{{ e.id }}"
            {% if request.args.get('empresa') == e.id|string %}selected{% endif %}>
            {{ e.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- ================= COLABORADOR ================= -->
    <div>
      <label class="text-xs font-semibold text-slate-600 dark:text-slate-300">
        Colaborador
      </label>

      <select name="colaborador"
              class="w-full mt-1 px-3 py-2 text-sm rounded-lg
                     bg-white dark:bg-slate-800
                     border border-slate-300 dark:border-slate-700">
        <option value="">Todos</option>

        {% for u in colaboradores %}
          <option value="{{ u.id }}"
            {% if request.args.get('colaborador') == u.id|string %}selected{% endif %}>
            {{ u.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- ================= PER√çODO ================= -->
    <div>
      <label class="text-xs font-semibold text-slate-600 dark:text-slate-300">
        Per√≠odo
      </label>

      <input
        type="text"
        id="periodo"
        name="periodo"
        value="{{ request.args.get('periodo','') }}"
        placeholder="Selecione o per√≠odo"
        autocomplete="off"
        readonly
        class="w-full mt-1 px-3 py-2 text-sm rounded-lg
               bg-white dark:bg-slate-800
               border border-slate-300 dark:border-slate-700
               cursor-pointer">
    </div>

    <!-- ================= ORDENAR ================= -->
    <div>
      <label class="text-xs font-semibold text-slate-600 dark:text-slate-300">
        Ordenar por
      </label>

      <select name="ordem"
              class="w-full mt-1 px-3 py-2 text-sm rounded-lg
                     bg-white dark:bg-slate-800
                     border border-slate-300 dark:border-slate-700">
        <option value="recentes" {% if request.args.get('ordem','recentes') == 'recentes' %}selected{% endif %}>
          Mais recentes
        </option>
        <option value="antigas" {% if request.args.get('ordem') == 'antigas' %}selected{% endif %}>
          Mais antigas
        </option>
        <option value="empresa_az" {% if request.args.get('ordem') == 'empresa_az' %}selected{% endif %}>
          Empresa (A ‚Üí Z)
        </option>
        <option value="empresa_za" {% if request.args.get('ordem') == 'empresa_za' %}selected{% endif %}>
          Empresa (Z ‚Üí A)
        </option>
        <option value="colab_az" {% if request.args.get('ordem') == 'colab_az' %}selected{% endif %}>
          Colaborador (A ‚Üí Z)
        </option>
        <option value="colab_za" {% if request.args.get('ordem') == 'colab_za' %}selected{% endif %}>
          Colaborador (Z ‚Üí A)
        </option>
      </select>
    </div>

    <!-- ================= BOT√ÉO ================= -->
    <div>
      <button
        type="submit"
        class="w-full px-4 py-2 rounded-lg
               bg-blue-600 hover:bg-blue-700
               text-white text-sm font-semibold shadow">
        Filtrar
      </button>

      <a href="{{ url_for(request.endpoint) }}"
         class="block mt-2 text-center text-[11px] text-slate-600 dark:text-slate-400 hover:underline">
        Limpar filtros
      </a>
    </div>

  </div>
</form>

<!-- ======================================================= -->
<!-- =================== TABELA COMPACTA =================== -->
<!-- ======================================================= -->
{% if logs %}
<div class="bg-white/80 dark:bg-slate-900/60 
            backdrop-blur-xl p-5 rounded-xl shadow-lg 
            border border-slate-300 dark:border-slate-800">

  <table class="w-full text-sm">
    <thead class="bg-slate-200 dark:bg-slate-800/50 
                  text-slate-600 dark:text-slate-400 
                  text-[11px] uppercase border-b">
      <tr>
        <th class="p-3 text-left">Empresa</th>
        <th class="p-3 text-left">Tarefa</th>
        <th class="p-3 text-left">Respons√°vel</th>
        <th class="p-3 text-left">Data</th>
        <th class="p-3 text-center">A√ß√µes</th>
      </tr>
    </thead>

    <tbody>
      {% for log in logs %}
      {% set tarefa = log.task %}
      {% set empresa = tarefa.contract.company if tarefa and tarefa.contract else None %}

      <tr class="border-b hover:bg-slate-100 dark:hover:bg-slate-800/40 transition">

        <td class="p-3">
          <div class="font-semibold">{{ empresa.name if empresa else "-" }}</div>
          <div class="text-[10px] text-slate-500">{{ empresa.cnpj if empresa else "" }}</div>
        </td>

        <td class="p-3">
          {{ tarefa.title if tarefa else "-" }}
        </td>

        <td class="p-3">
          <div>{{ log.user.name if log.user else "-" }}</div>
          <div class="text-[10px] text-slate-500">{{ log.user.email if log.user else "" }}</div>
        </td>

        <td class="p-3 text-[12px] text-slate-500">
          {{ log.created_at.strftime('%d/%m/%Y %H:%M') if log.created_at else "-" }}
        </td>

        <td class="p-3 text-center">
          <button onclick="abrirModal({{ log.id }})"
            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 
                   text-white text-[11px] rounded-lg shadow">
            Ver
          </button>
        </td>

      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ‚úÖ Carregar mais -->
  {% if has_more %}
    <div class="flex items-center justify-center pt-4">
      <a href="{{ next_url }}"
         class="px-5 py-3 bg-slate-900/90 hover:bg-slate-900 text-white
                dark:bg-white/10 dark:hover:bg-white/15
                rounded-lg shadow text-sm font-semibold transition
                inline-flex items-center gap-2">
        <i class="fa-solid fa-angles-down"></i> Carregar mais
      </a>
    </div>

    <p class="text-center text-[11px] mt-2 text-slate-500 dark:text-slate-500">
      Isso limita apenas a visualiza√ß√£o (exporta√ß√µes continuam completas).
    </p>
  {% endif %}

</div>
{% else %}
<p class="text-center text-slate-500 italic mt-10">
  Nenhuma atividade conclu√≠da at√© o momento.
</p>
{% endif %}

<!-- ======================================================= -->
<!-- ======================== MODAIS ======================= -->
<!-- ======================================================= -->
{% for log in logs %}
{% set tarefa = log.task %}
{% set empresa = tarefa.contract.company if tarefa and tarefa.contract else None %}

<div id="modal{{ log.id }}"
     class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">

  <div class="bg-white dark:bg-slate-900/95 
              w-full max-w-lg rounded-xl shadow-2xl p-6 
              border relative max-h-[90vh] overflow-y-auto">

    <button onclick="fecharModal({{ log.id }})"
      class="absolute top-3 right-4 text-xl hover:text-red-400">&times;</button>

    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
      <i class="fa-solid fa-circle-info text-blue-600"></i>
      Detalhes da Atividade
    </h2>

    <div class="space-y-4 text-sm">

      <p><strong>Empresa:</strong> {{ empresa.name if empresa else "-" }}</p>
      <p><strong>CNPJ:</strong> {{ empresa.cnpj if empresa else "-" }}</p>

      <hr>

      <p><strong>Tarefa:</strong> {{ tarefa.title if tarefa else "-" }}</p>
      <p><strong>Prazo:</strong> {{ tarefa.due_date if tarefa else "-" }}</p>

      {% if tarefa and tarefa.description %}
        <p><strong>Descri√ß√£o:</strong> {{ tarefa.description }}</p>
      {% endif %}

      <hr>

      <!-- ====================== ETAPAS ====================== -->
      <p class="font-semibold text-blue-600">Etapas realizadas</p>

      {% if tarefa and tarefa.steps %}
        <div class="space-y-3">
          {% for step in tarefa.steps %}
          <div class="border-l-4 border-blue-600 bg-slate-100 dark:bg-slate-800/60 
                      rounded-lg p-3">

            <p class="text-[11px] text-slate-500">
              {{ step.created_at.strftime('%d/%m/%Y %H:%M') if step.created_at else "-" }} ‚Äî
              <strong>{{ step.user.name if step.user else "-" }}</strong>
            </p>

            <p class="text-sm">{{ step.description }}</p>

            {% if step.file_path %}
              <a href="/{{ step.file_path }}" target="_blank"
                 class="text-xs text-blue-600 hover:underline mt-1 inline-block">
                üìé Ver anexo da etapa
              </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-xs text-slate-500 italic">
          Nenhuma etapa registrada.
        </p>
      {% endif %}

      <hr>

      <!-- ==================== CONCLUS√ÉO ==================== -->
      <p><strong>Executado por:</strong> {{ log.user.name if log.user else "-" }}</p>
      <p><strong>Data/Hora:</strong> {{ log.created_at.strftime('%d/%m/%Y %H:%M') if log.created_at else "-" }}</p>

      <div class="bg-slate-100 dark:bg-slate-800/60 rounded-lg p-4 whitespace-pre-line">
        {{ log.note or "" }}
      </div>

      <!-- ===================== ANEXOS ====================== -->
      <p class="font-semibold mt-2">Anexos da conclus√£o</p>

      {% if log.files %}
        <div class="grid grid-cols-2 gap-3">
          {% for f in log.files %}
            <a href="/{{ f.file_path }}" target="_blank"
               class="bg-slate-100 dark:bg-slate-800 
                      rounded-lg p-4 text-xs shadow hover:bg-blue-600 hover:text-white">
              <i class="fa-solid fa-paperclip mr-1"></i>
              {{ f.file_path.split('/')[-1] }}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-xs italic text-slate-500">Nenhum anexo.</p>
      {% endif %}

    </div>
  </div>
</div>
{% endfor %}

<!-- ======================================================= -->
<!-- ========================= JS =========================== -->
<!-- ======================================================= -->
<script>
/* ===========================
   MODAL
=========================== */
function abrirModal(id) {
  const modal = document.getElementById("modal" + id);
  if (!modal) return;
  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function fecharModal(id) {
  const modal = document.getElementById("modal" + id);
  if (!modal) return;
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

/* ===========================
   CALEND√ÅRIO DE PER√çODO
=========================== */
document.addEventListener("DOMContentLoaded", function () {
  const periodoInput = document.getElementById("periodo");

  if (periodoInput && typeof flatpickr !== "undefined") {
    flatpickr(periodoInput, {
      mode: "range",
      dateFormat: "d/m/Y",
      locale: "pt",
      allowInput: false,
      rangeSeparator: " at√© "
    });
  }
});
</script>

{% endblock %}
