{% extends "base.html" %}
{% block content %}

<!-- ======================================================= -->
<!-- ================= HEADER COMPACTO ====================== -->
<!-- ======================================================= -->
<section class="mb-6 relative">

  <div class="rounded-xl p-5 
              bg-white/80 dark:bg-slate-900/80 
              backdrop-blur-xl 
              border border-slate-300 dark:border-slate-800 
              shadow-lg flex items-center justify-between relative">

    <!-- GLOW -->
    <div class="absolute -top-7 -left-7 w-24 h-24 
                bg-blue-500/10 dark:bg-blue-600/20 
                blur-2xl rounded-full"></div>

    <div class="relative flex items-center gap-4">
      <div class="p-3 bg-blue-500/10 dark:bg-blue-600/20 
                  rounded-lg border border-blue-300/30 dark:border-blue-500/20">
        <i class="fa-solid fa-clock-rotate-left text-blue-600 dark:text-blue-300 text-xl"></i>
      </div>

      <div>
        <h1 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">
          Atividades Realizadas
        </h1>
        <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">
          Histórico completo das tarefas finalizadas
        </p>
      </div>
    </div>

  </div>

</section>


<!-- ======================================================= -->
<!-- =================== TABELA COMPACTA =================== -->
<!-- ======================================================= -->
{% if logs %}
<div class="bg-white/80 dark:bg-slate-900/60 
            backdrop-blur-xl p-5 rounded-xl shadow-lg 
            border border-slate-300 dark:border-slate-800">

  <table class="w-full rounded-lg text-sm">
    <thead class="bg-slate-200 dark:bg-slate-800/50 
                  text-slate-600 dark:text-slate-400 
                  text-[11px] uppercase tracking-wide 
                  border-b border-slate-300 dark:border-slate-700">
      <tr>
        <th class="p-3 text-left">Empresa</th>
        <th class="p-3 text-left">Tarefa</th>
        <th class="p-3 text-left">Responsável</th>
        <th class="p-3 text-left">Data</th>
        <th class="p-3 text-center">Ações</th>
      </tr>
    </thead>

    <tbody>
      {% for log in logs %}
      {% set tarefa = log.task %}
      {% set contrato = tarefa.contract if tarefa else None %}
      {% set empresa = contrato.company if contrato else None %}

      <tr class="border-b border-slate-200 dark:border-slate-800 
                 hover:bg-slate-100 dark:hover:bg-slate-800/40 
                 transition">

        <!-- EMPRESA -->
        <td class="p-3">
          <div class="font-semibold text-slate-800 dark:text-slate-100">{{ empresa.name }}</div>
          <div class="text-[10px] text-slate-500 dark:text-slate-400">{{ empresa.cnpj }}</div>
        </td>

        <!-- TAREFA -->
        <td class="p-3">
          <span class="font-medium text-slate-700 dark:text-slate-200">{{ tarefa.title }}</span>
        </td>

        <!-- RESPONSÁVEL -->
        <td class="p-3">
          <div class="text-slate-700 dark:text-slate-200">{{ log.user.name }}</div>
          <div class="text-[10px] text-slate-500 dark:text-slate-400">{{ log.user.email }}</div>
        </td>

        <!-- DATA -->
        <td class="p-3 text-[12px] text-slate-500 dark:text-slate-400">
          {{ log.created_at.strftime('%d/%m/%Y %H:%M') }}
        </td>

        <!-- AÇÃO -->
        <td class="p-3 text-center">
          <button onclick="abrirModal({{ log.id }})"
            class="px-3 py-1.5 
                   bg-blue-600 hover:bg-blue-700 
                   text-white text-[11px] rounded-lg shadow">
            Ver
          </button>
        </td>

      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

{% else %}
  <p class="text-center text-slate-500 dark:text-slate-400 mt-10 text-sm italic">
    Nenhuma atividade concluída até o momento.
  </p>
{% endif %}



<!-- ======================================================= -->
<!-- ===================== MODAIS COMPACTOS ================= -->
<!-- ======================================================= -->
{% for log in logs %}
{% set tarefa = log.task %}
{% set contrato = tarefa.contract if tarefa else None %}
{% set empresa = contrato.company if contrato else None %}

<div 
  id="modal{{ log.id }}"
  class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">

  <div class="bg-white dark:bg-slate-900/95 
              w-full max-w-lg rounded-xl shadow-2xl p-6 
              border border-slate-300 dark:border-slate-700 
              relative max-h-[90vh] overflow-y-auto">

    <!-- BOTÃO FECHAR -->
    <button onclick="fecharModal({{ log.id }})"
      class="absolute top-3 right-4 text-slate-500 dark:text-slate-400 hover:text-red-400 text-xl">
      &times;
    </button>

    <!-- TÍTULO -->
    <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
      <i class="fa-solid fa-circle-info text-blue-600 dark:text-blue-400"></i>
      Detalhes da Atividade
    </h2>

    <div class="space-y-4 text-sm text-slate-700 dark:text-slate-300">

      <p><strong class="text-blue-700 dark:text-blue-300">Empresa:</strong> {{ empresa.name }}</p>
      <p><strong class="text-blue-700 dark:text-blue-300">CNPJ:</strong> {{ empresa.cnpj }}</p>

      <div class="border-t border-slate-300 dark:border-slate-700"></div>

      <p><strong class="text-blue-700 dark:text-blue-300">Tarefa:</strong> {{ tarefa.title }}</p>

      {% if tarefa.description %}
      <p><strong class="text-blue-700 dark:text-blue-300">Descrição:</strong> {{ tarefa.description }}</p>
      {% endif %}

      <p><strong class="text-blue-700 dark:text-blue-300">Prazo:</strong> {{ tarefa.due_date }}</p>

      <div class="border-t border-slate-300 dark:border-slate-700"></div>

      <p><strong class="text-blue-700 dark:text-blue-300">Executado por:</strong> {{ log.user.name }}</p>
      <p><strong class="text-blue-700 dark:text-blue-300">Data/Hora:</strong> {{ log.created_at.strftime('%d/%m/%Y %H:%M') }}</p>

      <div class="border-t border-slate-300 dark:border-slate-700"></div>

      <!-- NOTA -->
      <p><strong class="text-blue-700 dark:text-blue-300">O que foi feito:</strong></p>
      <div class="bg-slate-100 dark:bg-slate-800/60 
                  border border-slate-300 dark:border-slate-700 
                  rounded-lg p-4 text-slate-700 dark:text-slate-300 
                  text-sm whitespace-pre-line">
        {{ log.note }}
      </div>

      <div class="border-t border-slate-300 dark:border-slate-700"></div>

      <!-- ======================================================= -->
      <!-- ================== ANEXOS EM QUADRADOS ================= -->
      <!-- ======================================================= -->
      <p><strong class="text-blue-700 dark:text-blue-300">Anexos:</strong></p>

      {% if log.files and log.files|length > 0 %}
      <div class="grid grid-cols-2 gap-3">
        {% for f in log.files %}
          <a href="/{{ f.file_path }}" target="_blank"
            class="bg-slate-100 dark:bg-slate-800 
                   rounded-lg p-4 h-24 flex items-center justify-center text-center
                   border border-slate-300 dark:border-slate-700 
                   hover:bg-blue-600 hover:text-white dark:hover:bg-blue-600 transition text-xs font-medium shadow">
            <i class="fa-solid fa-paperclip mr-2"></i>
            {{ f.file_path.split('/')[-1] }}
          </a>
        {% endfor %}
      </div>
      {% else %}
        <p class="text-slate-500 dark:text-slate-400 text-[12px] italic">
          Nenhum anexo enviado.
        </p>
      {% endif %}

    </div>

  </div>
</div>

{% endfor %}



<!-- ======================================================= -->
<!-- ========================= JS =========================== -->
<!-- ======================================================= -->
<script>
function abrirModal(id) {
  const modal = document.getElementById("modal" + id);
  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function fecharModal(id) {
  const modal = document.getElementById("modal" + id);
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}
</script>

{% endblock %}
