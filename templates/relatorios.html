{% extends "base.html" %}
{% block content %}

<!-- ================= HEADER ================= -->
<section class="mb-6 relative">
  <div class="rounded-xl p-5 
              bg-white/60 dark:bg-slate-900/80
              shadow-lg 
              border border-slate-300 dark:border-slate-800
              backdrop-blur-xl overflow-hidden relative">

    <div class="absolute -top-8 -left-8 w-32 h-32 
                bg-blue-400/10 dark:bg-blue-600/20 blur-2xl rounded-full"></div>

    <div class="absolute bottom-0 right-0 w-32 h-32 
                bg-cyan-400/10 dark:bg-cyan-500/10 blur-2xl rounded-full"></div>

    <div class="relative flex items-center justify-between gap-4 flex-wrap">
      <div class="flex items-center gap-4">
        <div class="p-3 bg-blue-500/10 dark:bg-blue-600/10 rounded-xl border border-blue-300/40 dark:border-blue-500/20">
          <i class="fa-solid fa-chart-column text-blue-600 dark:text-blue-400 text-2xl"></i>
        </div>

        <div>
          <h1 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">
            Relatórios
          </h1>
          <p class="text-xs mt-1 text-slate-600 dark:text-slate-400">
            Atividades concluídas com filtros por empresa e período
          </p>
        </div>
      </div>

      <!-- ✅ Exportações SEM `show` (sempre completo pelo filtro) -->
      <div class="flex items-center gap-2 flex-wrap">
        <a href="/relatorios/export/excel?empresa={{ empresa_sel or '' }}&periodo={{ periodo_sel or '' }}&ordem={{ ordem_sel or '' }}"
           class="px-4 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white 
                  rounded-lg shadow flex items-center gap-2 text-sm transition">
          <i class="fa-solid fa-file-excel"></i> Excel
        </a>

        <a href="/relatorios/export/pdf?empresa={{ empresa_sel or '' }}&periodo={{ periodo_sel or '' }}&ordem={{ ordem_sel or '' }}"
           class="px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white 
                  rounded-lg shadow flex items-center gap-2 text-sm transition">
          <i class="fa-solid fa-file-pdf"></i> PDF
        </a>

        <a href="/relatorios/export/word?empresa={{ empresa_sel or '' }}&periodo={{ periodo_sel or '' }}&ordem={{ ordem_sel or '' }}"
           class="px-4 py-2.5 bg-blue-700 hover:bg-blue-800 text-white 
                  rounded-lg shadow flex items-center gap-2 text-sm transition">
          <i class="fa-solid fa-file-word"></i> Word
        </a>
      </div>
    </div>

  </div>
</section>

<!-- ================= FILTROS ================= -->
<div class="rounded-xl shadow-xl border 
            border-slate-300 dark:border-slate-800
            bg-white/70 dark:bg-slate-900/60 backdrop-blur-md p-5 mb-6">

  <!-- ✅ Dica: por padrão o filtro volta pra 20 (não preserva show) -->
  <form method="GET" action="/relatorios" class="grid grid-cols-1 md:grid-cols-4 gap-4">

    <div>
      <label class="text-xs font-semibold text-slate-600 dark:text-slate-400">Empresa</label>
      <select name="empresa"
              class="w-full mt-1 bg-slate-100 dark:bg-slate-800 border border-slate-300 
                     dark:border-slate-700 p-3 rounded-lg text-sm">
        <option value="" {% if not empresa_sel %}selected{% endif %}>Todas</option>
        {% for e in empresas %}
          <option value="{{ e.id }}" {% if empresa_sel == (e.id|string) %}selected{% endif %}>
            {{ e.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="text-xs font-semibold text-slate-600 dark:text-slate-400">Período</label>
      <input id="periodo" name="periodo" value="{{ periodo_sel or '' }}"
             placeholder="Selecione um intervalo"
             class="w-full mt-1 bg-slate-100 dark:bg-slate-800 border border-slate-300 
                    dark:border-slate-700 p-3 rounded-lg text-sm">
      <p class="text-[11px] mt-1 text-slate-500 dark:text-slate-500">
        Selecione duas datas (início e fim).
      </p>
    </div>

    <div>
      <label class="text-xs font-semibold text-slate-600 dark:text-slate-400">Reordenar</label>
      <select name="ordem"
              class="w-full mt-1 bg-slate-100 dark:bg-slate-800 border border-slate-300 
                     dark:border-slate-700 p-3 rounded-lg text-sm">
        <option value="data_desc" {% if (ordem_sel or request.args.get('ordem','data_desc')) == "data_desc" %}selected{% endif %}>
          Data (mais recentes)
        </option>
        <option value="data_asc" {% if (ordem_sel or request.args.get('ordem','')) == "data_asc" %}selected{% endif %}>
          Data (mais antigas)
        </option>
        <option value="empresa_asc" {% if (ordem_sel or request.args.get('ordem','')) == "empresa_asc" %}selected{% endif %}>
          Empresa (A–Z)
        </option>
        <option value="empresa_desc" {% if (ordem_sel or request.args.get('ordem','')) == "empresa_desc" %}selected{% endif %}>
          Empresa (Z–A)
        </option>
        <option value="tarefa_asc" {% if (ordem_sel or request.args.get('ordem','')) == "tarefa_asc" %}selected{% endif %}>
          Tarefa (A–Z)
        </option>
        <option value="colab_asc" {% if (ordem_sel or request.args.get('ordem','')) == "colab_asc" %}selected{% endif %}>
          Colaborador (A–Z)
        </option>
      </select>
      <p class="text-[11px] mt-1 text-slate-500 dark:text-slate-500">
        Escolha a ordem de exibição dos registros.
      </p>
    </div>

    <div class="flex items-end gap-2">
      <button type="submit"
        class="w-full md:w-auto px-5 py-3 bg-blue-600 hover:bg-blue-700 text-white 
               rounded-lg shadow text-sm font-semibold transition flex items-center justify-center gap-2">
        <i class="fa-solid fa-filter"></i> Filtrar
      </button>

      <a href="/relatorios"
         class="w-full md:w-auto px-5 py-3 bg-slate-200 hover:bg-slate-300 
                dark:bg-slate-800 dark:hover:bg-slate-700
                border border-slate-300 dark:border-slate-700
                rounded-lg text-sm font-semibold transition text-center">
        Limpar
      </a>
    </div>

  </form>
</div>

<!-- ================= RESULTADOS ================= -->
<div class="rounded-xl shadow-xl border 
            border-slate-300 dark:border-slate-800
            bg-white/70 dark:bg-slate-900/60 backdrop-blur-md p-4 overflow-hidden">

  <div class="flex items-center justify-between px-2 pb-3 gap-3 flex-wrap">
    <div>
      <h3 class="font-semibold text-slate-800 dark:text-white">
        Atividades concluídas
      </h3>
      <p class="text-[12px] text-slate-600 dark:text-slate-400 mt-1">
        {% if empresa_sel %}
          Filtrando por empresa •
        {% else %}
          Todas as empresas •
        {% endif %}

        {% if periodo_sel %}
          Período: {{ periodo_sel }}
        {% else %}
          Sem filtro de período
        {% endif %}

        {% if show %}
          • Exibindo {{ show }} por vez
        {% endif %}
      </p>
    </div>

    <span class="text-[11px] text-slate-500 dark:text-slate-400">
      Mostrando {{ logs|length }} registro(s){% if total_count %} de {{ total_count }}{% endif %}
    </span>
  </div>

  <div class="overflow-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-200 dark:bg-slate-800/70
                    text-slate-700 dark:text-slate-300
                    text-[11px] uppercase tracking-wide 
                    border-b border-slate-300 dark:border-slate-700">
        <tr>
          <th class="p-3 text-left whitespace-nowrap">Data</th>
          <th class="p-3 text-left">Empresa</th>
          <th class="p-3 text-left">Tarefa</th>
          <th class="p-3 text-left">Colaborador</th>
          <th class="p-3 text-center">Ações</th>
        </tr>
      </thead>

      <tbody class="text-slate-700 dark:text-slate-200">
        {% for lg in logs %}
        <tr class="border-b border-slate-200 dark:border-slate-800
                   hover:bg-slate-100 dark:hover:bg-slate-800/40 transition">

          <td class="p-3 whitespace-nowrap text-slate-600 dark:text-slate-400">
            {{ lg.created_at.strftime("%d/%m/%Y %H:%M") if lg.created_at else "-" }}
          </td>

          <td class="p-3 font-medium">
            {{ lg.task.contract.company.name if lg.task and lg.task.contract and lg.task.contract.company else "-" }}
          </td>

          <td class="p-3">
            <div class="font-semibold text-slate-800 dark:text-white">
              {{ lg.task.title if lg.task else "-" }}
            </div>
            {% if lg.note %}
              <div class="text-[12px] mt-1 text-slate-600 dark:text-slate-400">
                {{ lg.note }}
              </div>
            {% endif %}
          </td>

          <td class="p-3 text-slate-600 dark:text-slate-400">
            {{ (lg.user.name if lg.user and lg.user.name is defined else (lg.user.username if lg.user and lg.user.username is defined else (lg.user if lg.user else "N/A"))) }}
          </td>

          <td class="p-3 text-center whitespace-nowrap">
            {% if lg.task %}
              <a href="/contract/{{ lg.task.contract_id }}"
                 class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs 
                        rounded-lg shadow inline-flex gap-2 transition">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> Ver contrato
              </a>
            {% endif %}
          </td>

        </tr>
        {% endfor %}

        {% if logs|length == 0 %}
        <tr>
          <td colspan="5" class="p-6 text-center text-slate-500 dark:text-slate-400">
            Nenhuma atividade concluída encontrada com os filtros selecionados.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ✅ Carregar mais (somente VISUALIZAÇÃO) -->
  {% if has_more %}
    <div class="flex items-center justify-center pt-4">
      <a href="{{ next_url }}"
         class="px-5 py-3 bg-slate-900/90 hover:bg-slate-900 text-white
                dark:bg-white/10 dark:hover:bg-white/15
                rounded-lg shadow text-sm font-semibold transition
                inline-flex items-center gap-2">
        <i class="fa-solid fa-angles-down"></i> Carregar mais
      </a>
    </div>

    <p class="text-center text-[11px] mt-2 text-slate-500 dark:text-slate-500">
    </p>
  {% endif %}

</div>

{% endblock %}
