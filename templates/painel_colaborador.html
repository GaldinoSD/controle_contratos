{% extends "base.html" %}
{% block content %}

<!-- ======================================================= -->
<!-- ===================== HEADER ========================== -->
<!-- ======================================================= -->

<section class="mb-6">
  <div class="rounded-2xl p-6 bg-white/80 dark:bg-slate-900/80
              backdrop-blur-xl border border-slate-300 dark:border-slate-800
              shadow-xl flex items-center gap-4">

    <div class="p-3 rounded-xl bg-blue-600/10 border border-blue-500/30">
      <i class="fa-solid fa-list-check text-blue-600 text-2xl"></i>
    </div>

    <div>
      <h1 class="text-2xl font-bold text-slate-800 dark:text-white">
        Atividades Pendentes
      </h1>
      <p class="text-sm text-slate-600 dark:text-slate-400">
        Registre etapas e finalize as atividades quando concluir
      </p>
    </div>
  </div>
</section>

<!-- ===================== FILTRO + LEGENDA ===================== -->
<div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

  <!-- ===== FILTRO POR EMPRESA + REORDENAR ===== -->
  <form method="GET">
    <div class="flex flex-col sm:flex-row sm:items-center gap-3">

      <label class="text-sm font-medium text-slate-700 dark:text-slate-300">
        Empresa:
      </label>

      <select name="empresa_id"
              onchange="this.form.submit()"
              class="px-3 py-2 text-sm rounded-lg
                     bg-white dark:bg-slate-800
                     border border-slate-300 dark:border-slate-700
                     text-slate-800 dark:text-slate-200">

        <option value="">Todas as empresas</option>

        {% for empresa in empresas %}
          <option value="{{ empresa.id }}"
            {% if empresa.id|string == request.args.get('empresa_id') %}
              selected
            {% endif %}
          >
            {{ empresa.name }}
          </option>
        {% endfor %}

      </select>

      <!-- ✅ REORDENAR POR ENTREGA -->
      <label class="text-sm font-medium text-slate-700 dark:text-slate-300 sm:ml-2">
        Reordenar:
      </label>

      <!-- mantém empresa_id ao trocar ordem (e vice-versa) -->
      <input type="hidden" name="empresa_id" value="{{ request.args.get('empresa_id','') }}">

      <select name="ordem"
              onchange="this.form.submit()"
              class="px-3 py-2 text-sm rounded-lg
                     bg-white dark:bg-slate-800
                     border border-slate-300 dark:border-slate-700
                     text-slate-800 dark:text-slate-200">

        <option value="due_asc"
          {% if request.args.get('ordem','due_asc') == 'due_asc' %}selected{% endif %}>
          Entrega (mais próxima)
        </option>

        <option value="due_desc"
          {% if request.args.get('ordem','') == 'due_desc' %}selected{% endif %}>
          Entrega (mais distante)
        </option>

      </select>

    </div>
  </form>

  <!-- ===== LEGENDA ===== -->
  <div class="flex flex-wrap gap-3 text-xs">

    <span class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-100 text-red-700">
      <span class="w-2.5 h-2.5 rounded-full bg-red-600"></span>
      Atrasada
    </span>

    <span class="flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-100 text-yellow-700">
      <span class="w-2.5 h-2.5 rounded-full bg-yellow-500"></span>
      Pendente
    </span>

    <span class="flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-700">
      <span class="w-2.5 h-2.5 rounded-full bg-blue-600"></span>
      Em andamento
    </span>

  </div>

</div>


<!-- ======================================================= -->
<!-- ======================== GRID ========================== -->
<!-- ======================================================= -->

{% if tarefas %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">

{% for t in tarefas %}
<div class="relative rounded-2xl p-5
            bg-gradient-to-br from-white/95 to-slate-100/80
            dark:from-slate-900/80 dark:to-slate-800/60
            backdrop-blur-xl border border-slate-300 dark:border-slate-700
            shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all">

  <!-- STATUS BAR (CORRIGIDA) -->
  <div class="absolute left-0 top-0 h-full w-1.5 rounded-l-2xl
    {% if t.is_overdue %}
      bg-red-600
    {% elif t.status == 'andamento' %}
      bg-blue-600
    {% else %}
      bg-yellow-500
    {% endif %}
  ">
  </div>

  <!-- BADGE STATUS -->
  <div class="absolute top-3 right-3">
    {% if t.is_overdue %}
      <span class="px-3 py-1 text-[10px] font-bold rounded-full bg-red-600 text-white">
        ATRASADA
      </span>
    {% elif t.status == 'andamento' %}
      <span class="px-3 py-1 text-[10px] font-bold rounded-full bg-blue-600 text-white">
        EM ANDAMENTO
      </span>
    {% else %}
      <span class="px-3 py-1 text-[10px] font-bold rounded-full bg-yellow-500 text-white">
        PENDENTE
      </span>
    {% endif %}
  </div>

  <div class="pl-4 space-y-4">

    <!-- EMPRESA -->
    <div class="flex items-start gap-3">
      <div class="p-2 rounded-lg bg-blue-600/10 border border-blue-500/30">
        <i class="fa-solid fa-building text-blue-600 text-sm"></i>
      </div>

      <div>
        <h2 class="text-sm font-semibold text-slate-800 dark:text-white">
          {{ t.contract.company.name if t.contract and t.contract.company else "Empresa não vinculada" }}
        </h2>
        <p class="text-[11px] text-slate-500">
          {{ t.contract.company.cnpj if t.contract and t.contract.company else "CNPJ não disponível" }}
        </p>
      </div>
    </div>

    <!-- TAREFA -->
    <div>
      <h3 class="text-lg font-bold text-slate-800 dark:text-white">
        {{ t.title }}
      </h3>

      <p class="text-sm text-slate-700 dark:text-slate-300 mt-1">
        {{ t.description or "Sem descrição adicional." }}
      </p>

      <p class="mt-2 text-xs text-slate-500 flex items-center gap-1">
        <i class="fa-regular fa-calendar"></i>
        Prazo: {{ t.due_date }}
      </p>
    </div>

    <!-- RESUMO ETAPAS (INALTERADO) -->
    <div class="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400">
      <span>
        <i class="fa-solid fa-shoe-prints"></i>
        {{ t.steps|length }} etapa(s)
      </span>

      {% if t.steps %}
      <button onclick="abrirModalVerEtapas({{ t.id }})"
              class="text-blue-600 hover:underline">
        Ver etapas
      </button>
      {% endif %}
    </div>

    <!-- AÇÕES (100% IGUAIS AO SEU CÓDIGO) -->
    <div class="pt-4 border-t border-slate-300 dark:border-slate-700 space-y-2">

      <button onclick="abrirModalEtapa({{ t.id }})"
        class="w-full py-2 rounded-lg text-xs font-semibold
               bg-blue-600 hover:bg-blue-700 text-white
               flex items-center justify-center gap-2">
        <i class="fa-solid fa-plus"></i>
        Registrar etapa
      </button>

      <form action="/task/complete/{{ t.id }}"
            method="POST"
            enctype="multipart/form-data"
            class="space-y-2">

        <textarea name="note" required
          placeholder="Considerações finais"
          class="w-full p-2 text-xs rounded-lg
                 bg-white dark:bg-slate-800/60
                 border border-slate-400 dark:border-slate-700"></textarea>

        <input type="file" name="files[]" multiple class="text-xs">

        <button
          class="w-full py-2 rounded-lg text-xs font-semibold
                 bg-emerald-600 hover:bg-emerald-700 text-white
                 flex items-center justify-center gap-2">
          <i class="fa-solid fa-check"></i>
          Concluir atividade
        </button>

      </form>
    </div>

  </div>
</div>

<!-- MODAL VER ETAPAS (INALTERADO) -->
<div id="modalVerEtapas-{{ t.id }}"
     class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm
            flex items-center justify-center px-4">
  <div class="w-full max-w-lg bg-white dark:bg-slate-900
              rounded-2xl shadow-2xl border border-slate-300
              dark:border-slate-700 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Etapas da atividade</h2>
      <button onclick="fecharModalVerEtapas({{ t.id }})">&times;</button>
    </div>

    <div class="max-h-80 overflow-y-auto space-y-3 pr-2">
      {% for s in t.steps %}
      <div class="relative pl-4 border-l-2 border-blue-500/40">
        <span class="absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full bg-blue-600"></span>
        <p>{{ s.description }}</p>
        <span class="text-xs text-slate-500">
          {{ s.created_at.strftime('%d/%m/%Y %H:%M') }}
        </span>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endfor %}
</div>
{% endif %}

<!-- MODAL REGISTRAR ETAPA (INALTERADO) -->
<div id="modalEtapa"
     class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm
            flex items-center justify-center px-4">
  <div class="relative w-full max-w-md bg-white dark:bg-slate-900
              rounded-2xl shadow-2xl border p-6">
    <button onclick="fecharModalEtapa()" class="absolute top-4 right-4">&times;</button>
    <form id="formEtapa" method="POST">
      <textarea name="step_description" required rows="4"
        class="w-full p-3 rounded-xl border"></textarea>
      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="fecharModalEtapa()">Cancelar</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function abrirModalEtapa(id){
  document.getElementById("modalEtapa").classList.remove("hidden");
  document.getElementById("formEtapa").action = `/task/${id}/add-step`;
}
function fecharModalEtapa(){
  document.getElementById("modalEtapa").classList.add("hidden");
}
function abrirModalVerEtapas(id){
  document.getElementById(`modalVerEtapas-${id}`).classList.remove("hidden");
}
function fecharModalVerEtapas(id){
  document.getElementById(`modalVerEtapas-${id}`).classList.add("hidden");
}
</script>

{% endblock %}
