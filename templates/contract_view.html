{% extends "base.html" %}
{% block content %}

<!-- ====================================================== -->
<!-- ================= CABE√áALHO COM ARQUIVOS ============== -->
<!-- ====================================================== -->
<section class="mb-6 relative">

  <div class="rounded-xl p-6 bg-slate-900/80 shadow-lg border border-slate-800
              backdrop-blur-xl overflow-hidden relative">

    <!-- Glows -->
    <div class="absolute -top-8 -left-8 w-28 h-28 bg-blue-600/20 blur-2xl rounded-full"></div>
    <div class="absolute bottom-0 right-0 w-28 h-28 bg-cyan-500/10 blur-2xl rounded-full"></div>

    <!-- Conte√∫do principal -->
    <div class="relative grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

      <!-- =============================================== -->
      <!--                  ESQUERDA                       -->
      <!-- =============================================== -->
      <div class="flex items-start gap-4">
        <div class="p-3 bg-blue-600/10 rounded-xl border border-blue-500/20">
          <i class="fa-solid fa-building text-blue-400 text-2xl"></i>
        </div>

        <div>
          <h1 class="text-2xl font-bold text-white tracking-tight">
            {{ contract.company.name }}
          </h1>

          <p class="text-slate-400 text-xs mt-1">
            Arquivos, tarefas e hist√≥rico do contrato.
          </p>

          <div class="mt-3 text-slate-300 text-xs leading-5">
            <p><strong>Contrato:</strong> {{ contract.id }}</p>
            <p><strong>CNPJ:</strong> {{ contract.company.cnpj }}</p>
            <p><strong>Vig√™ncia:</strong> {{ contract.start_date }} ‚Üí {{ contract.end_date }}</p>
          </div>
        </div>
      </div>


      <!-- =============================================== -->
      <!--                  DIREITA (ARQUIVOS)             -->
      <!-- =============================================== -->
      <div class="bg-slate-800/40 border border-slate-700 rounded-xl p-4 shadow-md">

        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-white flex items-center gap-2">
            <i class="fa-solid fa-file-contract text-blue-400"></i>
            Arquivos do Contrato
          </h2>

          {% if files|length > 0 %}
          <div class="flex items-center gap-2">
            <button onclick="abrirModalAtualizar()"
                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-[11px] rounded-lg shadow flex items-center gap-1">
              <i class="fa-solid fa-file-arrow-up"></i>
              Atualizar
            </button>

            <!-- üî• BOT√ÉO DE EXCLUS√ÉO CORRIGIDO -->
            <form method="POST" action="/contract/file/delete/{{ files[0].id }}"
                  onsubmit="return confirm('Tem certeza que deseja excluir o arquivo?');">
              <button class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-[11px] rounded-lg shadow flex items-center gap-1">
                <i class="fa-solid fa-trash"></i>
                Excluir
              </button>
            </form>
          </div>
          {% endif %}
        </div>


        <!-- Se n√£o houver arquivo -->
        {% if files|length == 0 %}
          <div class="text-center border border-dashed border-slate-600 rounded-lg p-4 bg-slate-900/40">
            <p class="text-slate-300 text-xs mb-3">Nenhum arquivo enviado ainda.</p>

            <form method="POST" action="/contract/{{ contract.id }}/upload"
                  enctype="multipart/form-data">

              <label class="w-full py-4 flex flex-col items-center justify-center 
                            border border-dashed border-slate-500 bg-slate-900/40 rounded-lg
                            cursor-pointer hover:bg-slate-900/70 transition">
                <i class="fa-solid fa-upload text-xl text-slate-400 mb-1"></i>
                <span class="text-[11px] text-slate-300">Selecionar arquivo</span>
                <input type="file" name="file" class="hidden" required>
              </label>

              <button class="mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700
                             text-white text-xs rounded-lg shadow">
                Enviar
              </button>
            </form>
          </div>

        {% else %}

          <!-- Lista de arquivos -->
          <div class="space-y-2 max-h-40 overflow-y-auto pr-1">

            {% for f in files %}
            <div class="flex items-center justify-between p-3 rounded-lg border border-slate-700 bg-slate-800/50">
              
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-file-pdf text-red-500 text-xl"></i>

                <div>
                  <a href="/{{ f.file_path }}" target="_blank"
                     class="text-blue-400 text-xs hover:underline">
                    {{ f.file_path.split('/')[-1] }}
                  </a>

                  <p class="text-[10px] text-slate-500">
                    {{ f.uploaded_at.strftime('%d/%m/%Y %H:%M') }}
                  </p>
                </div>
              </div>

            </div>
            {% endfor %}

          </div>

        {% endif %}
      </div>

    </div>
  </div>

</section>





<!-- ====================================================== -->
<!-- ==================== TAREFAS ========================== -->
<!-- ====================================================== -->
<section class="bg-slate-900/60 backdrop-blur-md border border-slate-800 rounded-xl p-6 shadow-xl">

  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-xl font-semibold text-white flex items-center gap-3">
        <i class="fa-solid fa-list-check text-blue-400"></i>
        Tarefas
      </h2>
      <p class="text-xs text-slate-400 mt-1">Demandas vinculadas ao contrato.</p>
    </div>

    <button onclick="abrirModalNovaTarefa()"
      class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg shadow flex items-center gap-2">
      <i class="fa-solid fa-plus"></i> Nova
    </button>
  </div>


  {% if tasks|length == 0 %}
    <p class="text-slate-400 text-xs">Nenhuma tarefa registrada.</p>

  {% else %}

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
      {% for t in tasks %}

        {% set atrasada = (t.status == 'pendente' and t.due_date < now().date()) %}
        
        <div class="p-4 rounded-xl border shadow bg-slate-800/40 min-h-[150px]
                    {% if atrasada %} border-red-500/40 bg-red-900/10
                    {% elif t.status == 'conclu√≠da' %} border-emerald-500/40 bg-emerald-900/10
                    {% else %} border-slate-700 {% endif %}">

          <div class="flex flex-col justify-between h-full">

            <div>
              <p class="text-white font-semibold text-sm">{{ t.title }}</p>

              <span class="text-[9px] px-2 py-0.5 rounded-full border mt-1 inline-block
                           {% if t.priority == 'Alta' %}
                             border-red-500/40 bg-red-900/20 text-red-300
                           {% elif t.priority == 'Baixa' %}
                             border-blue-500/40 bg-blue-900/20 text-blue-300
                           {% else %}
                             border-yellow-500/40 bg-yellow-900/20 text-yellow-300
                           {% endif %}">
                {{ t.priority }}
              </span>

              <p class="text-xs text-slate-400 mt-2">Entrega: {{ t.due_date }}</p>

              {% if t.description %}
                <p class="text-slate-300 text-[11px] mt-2 leading-relaxed">{{ t.description }}</p>
              {% endif %}
            </div>


            <div class="mt-3 text-right space-y-1">

              {% if t.status == 'pendente' %}

                {% if atrasada %}
                  <span class="inline-block text-[10px] px-2 py-0.5 rounded-full bg-red-900/30 text-red-300 font-semibold">
                    ATRASADA
                  </span>
                {% else %}
                  <span class="inline-block text-[10px] px-2 py-0.5 rounded-full bg-orange-900/30 text-orange-300 font-semibold">
                    PENDENTE
                  </span>
                {% endif %}

                {% if current_user.role == 'admin' %}
                  <button onclick="abrirModalFinalizar({{ t.id }})"
                          class="w-full mt-1 px-4 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-[11px] shadow flex items-center justify-center gap-1">
                    <i class="fa-solid fa-check text-xs"></i> Finalizar
                  </button>
                {% endif %}

              {% else %}
                <span class="inline-block text-[10px] px-2 py-0.5 rounded-full bg-emerald-900/30 text-emerald-300 font-semibold">
                  CONCLU√çDA
                </span>

                <button onclick="abrirDetalhes({{ t.id }})"
                        class="text-emerald-300 text-xs underline hover:text-emerald-100 flex items-center justify-end gap-1">
                  <i class="fa-solid fa-eye text-xs"></i> ver mais
                </button>
              {% endif %}

            </div>

          </div>

        </div>

      {% endfor %}
    </div>

  {% endif %}

</section>





<!-- ====================================================== -->
<!-- ======================== MODAIS ======================= -->
<!-- ====================================================== -->

<!-- MODAL NOVA TAREFA -->
<div id="modalNovaTarefa"
     class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">

  <div class="bg-slate-900/95 border border-slate-700 w-full max-w-md p-6 rounded-xl shadow-2xl relative">

    <button onclick="fecharModalNovaTarefa()" 
            class="absolute top-3 right-4 text-slate-300 hover:text-red-400 text-xl">&times;</button>

    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
      <i class="fa-solid fa-list-check text-blue-400"></i>
      Nova Tarefa
    </h2>

    <form action="/task/new/{{ contract.id }}" method="POST" class="space-y-4 text-slate-200">

      <div>
        <label class="text-xs font-medium">T√≠tulo</label>
        <input name="title"
               class="w-full bg-slate-800 border border-slate-700 px-3 py-2 rounded-lg text-sm"
               required>
      </div>

      <div class="grid grid-cols-2 gap-4">

        <div>
          <label class="text-xs font-medium">Entrega</label>
          <input type="date" name="due_date"
                 class="w-full bg-slate-800 border border-slate-700 px-3 py-2 rounded-lg text-sm"
                 required>
        </div>

        <div>
          <label class="text-xs font-medium">Prioridade</label>
          <select name="priority"
                  class="w-full bg-slate-800 border border-slate-700 px-3 py-2 rounded-lg text-sm">
            <option>Normal</option>
            <option>Alta</option>
            <option>Baixa</option>
          </select>
        </div>

      </div>

      <div>
        <label class="text-xs font-medium">Descri√ß√£o</label>
        <textarea name="description" rows="3"
                  class="w-full bg-slate-800 border border-slate-700 px-3 py-2 rounded-lg text-sm"></textarea>
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="fecharModalNovaTarefa()" 
                class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-xs">
          Cancelar
        </button>

        <button class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold shadow">
          Salvar
        </button>
      </div>

    </form>

  </div>
</div>




<!-- MODAL FINALIZAR -->
<div id="modalFinalizar"
     class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">

  <div class="bg-slate-900/95 border border-slate-700 w-full max-w-md p-6 rounded-xl shadow-2xl relative">

    <button onclick="fecharModalFinalizar()" 
            class="absolute top-3 right-4 text-slate-300 hover:text-red-400 text-xl">&times;</button>

    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
      <i class="fa-solid fa-check text-emerald-400"></i>
      Finalizar Tarefa
    </h2>

    <form id="formFinalizar" method="POST" enctype="multipart/form-data" class="space-y-4 text-slate-200">

      <div>
        <label class="text-xs font-medium">Descri√ß√£o da conclus√£o</label>
        <textarea name="note" required rows="3"
                  class="w-full bg-slate-800 border border-slate-700 px-3 py-2 rounded-lg text-sm"></textarea>
      </div>

      <div>
        <label class="text-xs font-medium">Anexo (opcional)</label>
        <input type="file" name="file"
               class="w-full bg-slate-800 border border-slate-700 px-3 py-2 rounded-lg text-sm">
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="fecharModalFinalizar()" 
                class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-xs">
          Cancelar
        </button>

        <button class="px-5 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-semibold shadow">
          Finalizar
        </button>
      </div>

    </form>

  </div>
</div>




<!-- MODAL ATUALIZAR ARQUIVO -->
<div id="modalAtualizar"
     class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">

  <div class="bg-slate-900/95 border border-slate-700 w-full max-w-md p-6 rounded-xl shadow-2xl relative">

    <button onclick="fecharModalAtualizar()" 
            class="absolute top-3 right-4 text-slate-300 hover:text-red-400 text-xl">&times;</button>

    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
      <i class="fa-solid fa-file-arrow-up text-blue-400"></i>
      Atualizar Arquivo
    </h2>

    <form action="/contract/{{ contract.id }}/upload" method="POST" enctype="multipart/form-data" 
          class="space-y-4 text-slate-200">

      <label class="w-full h-28 flex flex-col items-center justify-center border border-dashed 
                    border-slate-600 bg-slate-800/40 rounded-lg cursor-pointer hover:bg-slate-800 transition">
        <i class="fa-solid fa-upload text-2xl text-slate-400 mb-1"></i>
        <span class="text-xs">Selecione um arquivo</span>
        <input type="file" name="file" class="hidden" required>
      </label>

      <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg shadow text-xs font-semibold">
        Enviar
      </button>

    </form>

  </div>
</div>




<!-- MODAL DETALHES -->
<div id="modalDetalhes"
     class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">

  <div class="bg-slate-900/95 border border-slate-700 w-full max-w-lg p-6 rounded-xl shadow-2xl relative">

    <button onclick="fecharDetalhes()" 
            class="absolute top-3 right-4 text-slate-300 hover:text-red-400 text-xl">&times;</button>

    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
      <i class="fa-solid fa-clipboard-check text-emerald-400"></i>
      Detalhes da Tarefa
    </h2>

    <div id="conteudoDetalhes" class="space-y-2 text-sm text-slate-200"></div>

  </div>
</div>




<!-- ====================================================== -->
<!-- ======================== JS ========================== -->
<!-- ====================================================== -->
<script>

function abrirModalNovaTarefa(){ modalNovaTarefa.classList.remove("hidden"); }
function fecharModalNovaTarefa(){ modalNovaTarefa.classList.add("hidden"); }

function abrirModalAtualizar(){ modalAtualizar.classList.remove("hidden"); }
function fecharModalAtualizar(){ modalAtualizar.classList.add("hidden"); }

function abrirModalFinalizar(id){
  formFinalizar.action = `/task/complete/${id}`;
  modalFinalizar.classList.remove("hidden");
}
function fecharModalFinalizar(){ modalFinalizar.classList.add("hidden"); }

function abrirDetalhes(id){
  fetch(`/task/logs/${id}`)
    .then(r => r.json())
    .then(d => {

      let html = `
        <p><strong class="text-blue-300">Feito por:</strong> ${d.user}</p>
        <p><strong class="text-blue-300">Data:</strong> ${d.data}</p>
        <p><strong class="text-blue-300">Descri√ß√£o:</strong><br>${d.note}</p>
      `;

      if(d.file){
        html += `
          <p><strong class="text-blue-300">Anexo:</strong></p>
          <a href="/${d.file}" target="_blank" class="text-blue-400 underline">Abrir arquivo</a>
        `;
      }

      conteudoDetalhes.innerHTML = html;
      modalDetalhes.classList.remove("hidden");
    });
}

function fecharDetalhes(){ modalDetalhes.classList.add("hidden"); }

</script>

{% endblock %}
